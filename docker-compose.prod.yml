version: '3.8'

services:
    postgres:
        image: postgres:16-alpine
        container_name: kitchenpace-db
        environment:
            POSTGRES_USER: kitchenpace
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kitchenpace_secret}
            POSTGRES_DB: ${POSTGRES_DB:-live_kitchenpace}
        volumes:
            - postgres_data:/var/lib/postgresql/data
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U kitchenpace -d ${POSTGRES_DB:-live_kitchenpace}']
            interval: 10s
            timeout: 5s
            retries: 5

    redis:
        image: redis:7-alpine
        container_name: kitchenpace-redis
        volumes:
            - redis_data:/data
        healthcheck:
            test: ['CMD-SHELL', 'redis-cli ping | grep PONG']
            interval: 10s
            timeout: 3s
            retries: 5

    opensearch:
        image: opensearchproject/opensearch:3.0.0
        container_name: kitchenpace-opensearch
        environment:
            discovery.type: single-node
            plugins.security.disabled: 'true'
            OPENSEARCH_JAVA_OPTS: '-Xms512m -Xmx512m'
            bootstrap.memory_lock: 'true'
            OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-1snt-Funny1}
        ulimits:
            memlock:
                soft: -1
                hard: -1
        volumes:
            - opensearch_data:/usr/share/opensearch/data
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'curl -fsSL http://localhost:9200/_cluster/health | grep -q "\"status\""',
                ]
            interval: 15s
            timeout: 5s
            retries: 5

    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: runner
            args:
                DATABASE_URL: ${DATABASE_URL:-postgresql://kitchenpace:kitchenpace_secret@postgres:5432/live_kitchenpace}
                DEBUG: 0
            cache_from:
                - kitchenpace-app:latest
        container_name: kitchenpace-app
        env_file:
            - .env
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            opensearch:
                condition: service_healthy
        restart: unless-stopped

    worker:
        build:
            context: .
            dockerfile: Dockerfile
            target: worker
            args:
                DATABASE_URL: ${DATABASE_URL:-postgresql://kitchenpace:kitchenpace_secret@postgres:5432/live_kitchenpace}
                REDIS_HOST: redis
                REDIS_PORT: 6379
                REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            cache_from:
                - kitchenpace-worker:latest
        container_name: kitchenpace-worker
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            opensearch:
                condition: service_healthy
        restart: unless-stopped
        environment:
            DATABASE_URL: ${DATABASE_URL:-postgresql://kitchenpace:kitchenpace_secret@postgres:5432/live_kitchenpace}
            REDIS_HOST: redis
            REDIS_PORT: 6379
            REDIS_PASSWORD: ${REDIS_PASSWORD:-}
            OPENSEARCH_URL: http://opensearch:9200
            OPENSEARCH_INDEX: recipes

volumes:
    postgres_data:
    redis_data:
    opensearch_data:
