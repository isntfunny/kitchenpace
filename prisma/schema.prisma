generator client {
  provider = "prisma-client-js"
  output   = "../node_modules/.prisma/client"
}

datasource db {
  provider = "postgresql"
}

// ============================================
// ENUMS
// ============================================

enum Role {
  USER
  ADMIN
}

enum Difficulty {
  EASY
  MEDIUM
  HARD
}

enum RecipeStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum MealStatus {
  PLANNED
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}

enum ShoppingCategory {
  GEMUESE
  OBST
  FLEISCH
  FISCH
  MILCHPRODUKTE
  GEWURZE
  BACKEN
  GETRAENKE
  SONSTIGES
}

enum NotificationType {
  NEW_FOLLOWER
  RECIPE_LIKE
  RECIPE_COMMENT
  RECIPE_RATING
  RECIPE_COOKED
  RECIPE_PUBLISHED
  WEEKLY_PLAN_REMINDER
  SYSTEM
}

enum ActivityType {
  RECIPE_CREATED
  RECIPE_COOKED
  RECIPE_RATED
  RECIPE_COMMENTED
  RECIPE_FAVORITED
  RECIPE_UNFAVORITED
  USER_FOLLOWED
  USER_REGISTERED
  USER_ACTIVATED
  MEAL_PLAN_CREATED
}

// ============================================
// AUTH MODELS (NextAuth)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String   @id
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// USER & PROFILE
// ============================================

model User {
  id              String    @id @default(cuid())
  name            String?
  email           String?   @unique
  emailVerified   DateTime?
  image           String?
  hashedPassword  String?
  role            Role      @default(USER)
  isActive        Boolean   @default(false) // Must be activated via email
  activationToken String?
  resetToken      String?
  resetTokenExpiry DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  // Relations
  accounts        Account[]
  sessions        Session[]
  profile        Profile?
  recipes        Recipe[]
  comments       Comment[]
  ratings        UserRating[]
  favorites      Favorite[]
  followedBy     Follow[]   @relation("FollowedBy")
  following      Follow[]   @relation("Following")
  notifications  Notification[]
  pushSubscriptions PushSubscription[]
  mealPlans      MealPlan[]
  shoppingLists  ShoppingList[]
  activities     ActivityLog[]
  viewHistory    UserViewHistory[]
  cookHistory    UserCookHistory[]
  pinnedFavorites PinnedFavorite[]
  cookImages     CookImage[]
}

model Profile {
  id             String   @id @default(cuid())
  userId         String   @unique
  email          String
  nickname       String?
  teaser         String?
  photoUrl       String?
  bio            String?
  followerCount  Int      @default(0)
  followingCount Int      @default(0)
  recipeCount    Int      @default(0)
  ratingsPublic   Boolean  @default(true)
  followsPublic   Boolean  @default(true)
  favoritesPublic Boolean  @default(true)
  showInActivity  Boolean  @default(true)
  notifyOnAnonymous Boolean  @default(false)
  notifyOnNewFollower Boolean  @default(true)
  notifyOnRecipeLike Boolean  @default(true)
  notifyOnRecipeComment Boolean  @default(true)
  notifyOnRecipeRating Boolean  @default(true)
  notifyOnRecipeCooked Boolean  @default(true)
  notifyOnRecipePublished Boolean  @default(true)
  notifyOnWeeklyPlanReminder Boolean  @default(true)
  notifyOnSystemMessages Boolean  @default(true)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// ============================================
// RECIPE & INGREDIENTS
// ============================================

model Recipe {
  id           String      @id @default(cuid())
  title        String
  slug         String      @unique
  description  String?
  imageUrl     String?
  imageKey     String?
  blurhash     String?
  imageWidth   Int?
  imageHeight  Int?
  servings     Int         @default(4)
  prepTime     Int         @default(0)
  cookTime     Int         @default(0)
  totalTime    Int         @default(0)
  difficulty   Difficulty  @default(MEDIUM)
  status       RecipeStatus @default(DRAFT)
  publishedAt  DateTime?
  rating       Float       @default(0)
  ratingCount  Int         @default(0)
  viewCount    Int         @default(0)
  cookCount    Int         @default(0)
  isTrending   Boolean     @default(false)
  
  // Flow data as JSON
  flowNodes    Json?
  flowEdges    Json?
  
  authorId     String
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  // Relations
  author       User        @relation(fields: [authorId], references: [id], onDelete: Cascade)
  categories   RecipeCategory[]
  recipeIngredients RecipeIngredient[]
  comments     Comment[]
  ratings      UserRating[]
  favorites    Favorite[]
  tags         RecipeTag[]
  mealPlanRecipes MealPlanRecipe[]
  shoppingItems ShoppingItem[]
  userViewHistory UserViewHistory[]
  cookHistory  UserCookHistory[]
  pinnedFavorites PinnedFavorite[]
  cookImages   CookImage[]

  @@index([authorId])
  @@index([difficulty])
  @@index([createdAt])
  @@index([rating])
  @@index([status])
  @@index([isTrending])
}

// ============================================
// INGREDIENTS (Master List + Recipe-specific)
// ============================================

model Ingredient {
  id        String            @id @default(cuid())
  name      String
  slug      String            @unique
  category  ShoppingCategory?
  units     String[]
  recipes   RecipeIngredient[]
  shoppingItems ShoppingItem[]
  createdAt DateTime          @default(now())

  @@index([name])
}

model RecipeIngredient {
  id           String   @id @default(cuid())
  recipeId     String
  ingredientId String
  amount       String   // Recipe-specific: "400", "1/2", "2-3"
  unit         String   // Selected unit from ingredient.units
  notes        String?  // "finely chopped", "room temperature", etc.
  position     Int      @default(0) // For ordering in list
  isOptional   Boolean  @default(false)

  recipe       Recipe     @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  ingredient   Ingredient @relation(fields: [ingredientId], references: [id], onDelete: Cascade)

  @@unique([recipeId, ingredientId])
  @@index([recipeId])
  @@index([ingredientId])
}

// ============================================
// CATEGORIES & TAGS
// ============================================

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  description String?
  imageUrl    String?
  color       String?  // Hex color for UI theming
  createdAt   DateTime @default(now())

  recipes RecipeCategory[]
}

model RecipeCategory {
  recipeId   String
  categoryId String
  position   Int      @default(0) // For ordering categories

  recipe   Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@id([recipeId, categoryId])
  @@index([recipeId])
  @@index([categoryId])
}

model Tag {
  id        String      @id @default(cuid())
  name      String      @unique
  slug      String      @unique
  recipes   RecipeTag[]
  createdAt DateTime    @default(now())
}

model RecipeTag {
  recipeId String
  tagId    String
  createdAt DateTime @default(now())

  recipe   Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  tag      Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@id([recipeId, tagId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  imageUrl  String?
  recipeId  String
  authorId  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  author User   @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([authorId])
}

// ============================================
// SOCIAL: RATINGS & FAVORITES
// ============================================

model UserRating {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String
  rating    Int      // 1-5
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId])
  @@index([recipeId])
  @@index([userId])
}

model Favorite {
  id        String   @id @default(cuid())
  recipeId  String
  userId    String
  createdAt DateTime @default(now())

  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([recipeId, userId])
  @@index([userId])
}

// ============================================
// SOCIAL: FOLLOW SYSTEM
// ============================================

model Follow {
  id          String   @id @default(cuid())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower    User     @relation("FollowedBy", fields: [followerId], references: [id], onDelete: Cascade)
  following   User     @relation("Following", fields: [followingId], references: [id], onDelete: Cascade)

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

// ============================================
// NOTIFICATIONS
// ============================================

model Notification {
  id        String           @id @default(cuid())
  userId    String
  type      NotificationType
  title     String
  message   String
  data      Json?            // Additional data: { recipeId, userId, etc. }
  read      Boolean          @default(false)
  createdAt DateTime         @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, read])
}

model PushSubscription {
  id        String   @id @default(cuid())
  userId    String
  endpoint  String   @unique
  keys      Json
  label     String?  // e.g. device or browser name
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// ============================================
// MEAL PLANNING
// ============================================

model MealPlan {
  id        String             @id @default(cuid())
  userId    String
  name      String?
  startDate DateTime
  endDate   DateTime
  meals     MealPlanRecipe[]
  shoppingLists ShoppingList[]
  createdAt DateTime           @default(now())
  updatedAt DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, startDate])
}

model MealPlanRecipe {
  id          String      @id @default(cuid())
  mealPlanId  String
  recipeId    String
  date        DateTime
  mealType    MealType
  servings    Int         @default(4)
  status      MealStatus  @default(PLANNED)
  notes       String?

  mealPlan    MealPlan    @relation(fields: [mealPlanId], references: [id], onDelete: Cascade)
  recipe      Recipe      @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([mealPlanId])
  @@index([recipeId])
}

// ============================================
// SHOPPING LISTS
// ============================================

model ShoppingList {
  id          String          @id @default(cuid())
  userId      String
  name        String?
  mealPlanId  String?
  items       ShoppingItem[]
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  mealPlan    MealPlan?       @relation(fields: [mealPlanId], references: [id], onDelete: SetNull)

  @@index([userId])
}

model ShoppingItem {
  id             String           @id @default(cuid())
  shoppingListId String
  recipeId       String?          // Original recipe (optional)
  ingredientId   String?          // Master ingredient (optional)
  name           String           // Display name (fallback)
  amount         String?
  unit           String?
  category       ShoppingCategory @default(SONSTIGES)
  checked        Boolean           @default(false)
  position       Int               @default(0)

  shoppingList   ShoppingList      @relation(fields: [shoppingListId], references: [id], onDelete: Cascade)
  recipe         Recipe?          @relation(fields: [recipeId], references: [id], onDelete: SetNull)
  ingredient     Ingredient?      @relation(fields: [ingredientId], references: [id], onDelete: SetNull)

  @@index([shoppingListId])
}

// ============================================
// ACTIVITY & VIEW HISTORY
// ============================================

model ActivityLog {
  id         String       @id @default(cuid())
  userId     String
  type       ActivityType
  targetId   String?
  targetType String?
  metadata   Json?
  createdAt  DateTime     @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
}

model UserViewHistory {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String
  viewedAt  DateTime @default(now())
  pinned    Boolean  @default(false)

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, recipeId])
  @@index([userId])
  @@index([recipeId])
  @@index([userId, viewedAt])
}

model UserCookHistory {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String
  cookedAt  DateTime @default(now())
  servings  Int?
  notes     String?
  imageUrl  String?  // User's photo of the cooked meal
  imageKey  String?  // S3 key for the image

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([recipeId])
  @@index([userId, cookedAt])
}

// ============================================
// COOK IMAGES (User-submitted photos)
// ============================================

model CookImage {
  id          String   @id @default(cuid())
  recipeId    String
  userId      String
  imageUrl    String
  imageKey    String?  // S3 key for the image
  blurhash    String?
  caption     String?
  createdAt   DateTime @default(now())

  recipe      Recipe   @relation(fields: [recipeId], references: [id], onDelete: Cascade)
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([recipeId])
  @@index([userId])
  @@index([createdAt])
}

// ============================================
// PINNED FAVORITES (KUC-5)
// ============================================

model PinnedFavorite {
  id        String   @id @default(cuid())
  userId    String
  recipeId  String
  position  Int      // 0, 1, or 2 (max 3)
  createdAt DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  recipe Recipe @relation(fields: [recipeId], references: [id], onDelete: Cascade)

  @@unique([userId, position])
  @@unique([userId, recipeId])
  @@index([userId])
}

// ============================================
// JOB RUNS (BullMQ History)
// ============================================

model JobRun {
  id            String    @id @default(cuid())
  queueName     String
  jobName       String
  jobId        String?   // BullMQ job ID
  status       JobStatus @default(PENDING)
  payload      Json?     // Job input data
  result       Json?     // Job output/result
  errorMessage String?   // Error message if failed
  attempts     Int       @default(0)
  startedAt    DateTime?
  completedAt  DateTime?
  createdAt    DateTime  @default(now())

  @@index([queueName, createdAt])
  @@index([status, createdAt])
  @@index([jobId])
}
