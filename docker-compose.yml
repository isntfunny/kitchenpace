version: '3.8'

services:
    postgres:
        image: postgres:16-alpine
        container_name: kitchenpace-db
        environment:
            POSTGRES_USER: kitchenpace
            POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-kitchenpace_secret}
            POSTGRES_DB: kitchenpace
        volumes:
            - postgres_data:/var/lib/postgresql/data

        ports:
            - '64000:5432'
        healthcheck:
            test: ['CMD-SHELL', 'pg_isready -U kitchenpace -d kitchenpace']
            interval: 10s
            timeout: 5s
            retries: 5

    opensearch:
        image: opensearchproject/opensearch:3.0.0
        container_name: kitchenpace-opensearch
        environment:
            discovery.type: single-node
            plugins.security.disabled: 'true'
            OPENSEARCH_JAVA_OPTS: '-Xms512m -Xmx512m'
            bootstrap.memory_lock: 'true'
            OPENSEARCH_INITIAL_ADMIN_PASSWORD: ${OPENSEARCH_INITIAL_ADMIN_PASSWORD:-1snt-Funny1}
        ulimits:
            memlock:
                soft: -1
                hard: -1
        ports:
            - '9200:9200'
            - '9600:9600'
        volumes:
            - opensearch_data:/usr/share/opensearch/data
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'curl -fsSL http://localhost:9200/_cluster/health | grep -q "\"status\""',
                ]
            interval: 15s
            timeout: 5s
            retries: 5

    app:
        build:
            context: .
            dockerfile: Dockerfile
            target: runner
            args:
                DATABASE_URL: ${DATABASE_URL:-postgresql://kitchenpace:kitchenpace_secret@postgres:5432/kitchenpace}
                DEBUG: ${DEBUG:-0}
        container_name: kitchenpace-app
        depends_on:
            postgres:
                condition: service_healthy
            opensearch:
                condition: service_healthy
        environment:
            DATABASE_URL: postgresql://kitchenpace:${POSTGRES_PASSWORD:-kitchenpace_secret}@postgres:5432/kitchenpace
            NODE_ENV: development
            DEBUG: ${DEBUG:-0}
            # NextAuth (set these in Coolify environment variables)
            NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-change-this-in-production}
            NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
            OPENSEARCH_URL: http://opensearch:9200
            OPENSEARCH_INDEX: recipes
            TRIGGER_API_URL: ${TRIGGER_API_URL:-https://task-trigger.isntfunny.de}
            TRIGGER_ACCESS_TOKEN: ${TRIGGER_ACCESS_TOKEN:-}
        restart: unless-stopped

    # worker:
    #     build:
    #         context: .
    #         dockerfile: Dockerfile
    #         target: worker
    #         args:
    #             DATABASE_URL: ${DATABASE_URL:-postgresql://kitchenpace:kitchenpace_secret@postgres:5432/kitchenpace}
    #             TRIGGER_API_URL: ${TRIGGER_API_URL:-https://task-trigger.isntfunny.de}
    #             TRIGGER_ACCESS_TOKEN: ${TRIGGER_ACCESS_TOKEN:-}
    #     container_name: kitchenpace-worker
    #     depends_on:
    #         postgres:
    #             condition: service_healthy
    #         opensearch:
    #             condition: service_healthy
    #     restart: unless-stopped
    #     environment:
    #         OPENSEARCH_URL: http://opensearch:9200
    #         OPENSEARCH_INDEX: recipes
    #         TRIGGER_API_URL: ${TRIGGER_API_URL:-https://task-trigger.isntfunny.de}
    #         TRIGGER_ACCESS_TOKEN: ${TRIGGER_ACCESS_TOKEN:-}

    docker-proxy:
        image: tecnativa/docker-socket-proxy:${DOCKER_PROXY_IMAGE_TAG:-latest}
        container_name: kitchenpace-docker-proxy
        restart: ${RESTART_POLICY:-unless-stopped}
        volumes:
            - /var/run/docker.sock:/var/run/docker.sock:ro
        networks:
            - docker-proxy
        environment:
            - LOG_LEVEL=info
            - POST=1
            - CONTAINERS=1
            - IMAGES=1
            - INFO=1
            - NETWORKS=1
        healthcheck:
            test: ['CMD', 'nc', '-z', '127.0.0.1', '2375']
            interval: 30s
            timeout: 5s
            retries: 5

    trigger-supervisor:
        image: ghcr.io/triggerdotdev/supervisor:${TRIGGER_IMAGE_TAG:-v4-beta}
        container_name: kitchenpace-trigger-supervisor
        restart: ${RESTART_POLICY:-unless-stopped}
        depends_on:
            docker-proxy:
                condition: service_healthy
        networks:
            - default
            - docker-proxy
        volumes:
            - trigger_shared:/home/node/shared
        user: root
        command: sh -c "chown -R node:node /home/node/shared && exec /usr/bin/dumb-init -- pnpm run --filter supervisor start"
        environment:
            TRIGGER_WORKER_TOKEN: ${TRIGGER_WORKER_TOKEN}
            MANAGED_WORKER_SECRET: ${MANAGED_WORKER_SECRET}
            TRIGGER_API_URL: ${TRIGGER_API_URL:-https://task-trigger.isntfunny.de}
            OTEL_EXPORTER_OTLP_ENDPOINT: ${OTEL_EXPORTER_OTLP_ENDPOINT:-https://task-trigger.isntfunny.de/otel}
            TRIGGER_WORKLOAD_API_DOMAIN: supervisor
            TRIGGER_WORKLOAD_API_PORT_EXTERNAL: 8020
            DEBUG: ${DEBUG:-1}
            ENFORCE_MACHINE_PRESETS: 1
            TRIGGER_DEQUEUE_INTERVAL_MS: 1000
            DOCKER_HOST: tcp://docker-proxy:2375
            DOCKER_RUNNER_NETWORKS: default
            DOCKER_REGISTRY_URL: ${DOCKER_REGISTRY_URL:-localhost:5000}
            DOCKER_REGISTRY_USERNAME: ${DOCKER_REGISTRY_USERNAME:-}
            DOCKER_REGISTRY_PASSWORD: ${DOCKER_REGISTRY_PASSWORD:-}
            DOCKER_AUTOREMOVE_EXITED_CONTAINERS: 0
        healthcheck:
            test:
                [
                    'CMD',
                    'node',
                    '-e',
                    "http.get('http://localhost:8020/health', res => process.exit(res.statusCode === 200 ? 0 : 1)).on('error', () => process.exit(1))",
                ]
            interval: 30s
            timeout: 10s
            retries: 5
            start_period: 10s

networks:
    docker-proxy:
        name: docker-proxy

volumes:
    postgres_data:
    opensearch_data:
    trigger_shared:
